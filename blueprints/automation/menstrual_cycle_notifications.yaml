blueprint:
  name: Menstrual Cycle Tracker - Notifications
  description: >
    Send notifications for cycle events: period due soon, period started/ended,
    fertile window, PMS window, and ovulation phase. Each notification type can
    be individually enabled or disabled.

    Select your tracker once â€” all other entities are detected automatically
    from the same device.

    Set the subject and possessive fields to personalise messages for yourself
    or someone else â€” e.g. "You / Your" (default), "Alex / Alex's", or
    "They / Their".
  domain: automation
  input:

    # â”€â”€ Tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    period_active_sensor:
      name: Cycle Tracker
      description: >
        Select the "Period Active" sensor for the tracker you want notifications
        for. All other tracker entities are detected automatically.
      selector:
        entity:
          domain: binary_sensor
          integration: menstrual_cycle_tracker

    # â”€â”€ Notification service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    notify_service:
      name: Notification Service
      description: >
        The service to call for notifications, e.g. notify.mobile_app_my_phone
        or notify.notify for the default service.
      default: notify.notify
      selector:
        text:

    # â”€â”€ Pronouns / name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    name_subject:
      name: Subject (who the tracker is for)
      description: >
        Used as the subject in notification messages.
        Examples: "You", "Alex", "She", "He", "They"
      default: "You"
      selector:
        text:

    name_possessive:
      name: Possessive (who the tracker belongs to)
      description: >
        Used as the possessive in notification messages.
        Examples: "Your", "Alex's", "Her", "His", "Their"
      default: "Your"
      selector:
        text:

    # â”€â”€ Daily check time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    daily_check_time:
      name: Daily Check Time
      description: Time each day to check for upcoming period / PMS window.
      default: "08:00:00"
      selector:
        time:

    # â”€â”€ Period due soon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_period_due:
      name: Notify - Period Due Soon
      description: Send a notification when the period is predicted N days away.
      default: true
      selector:
        boolean:

    period_warning_days:
      name: Period Warning (Days Before)
      description: How many days before the predicted period to send the alert.
      default: 2
      selector:
        number:
          min: 1
          max: 7
          unit_of_measurement: days

    # â”€â”€ Period started â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_period_started:
      name: Notify - Period Started
      description: Send a notification when the period active sensor turns on.
      default: true
      selector:
        boolean:

    # â”€â”€ Period ended â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_period_ended:
      name: Notify - Period Ended
      description: Send a notification when the period active sensor turns off.
      default: true
      selector:
        boolean:

    # â”€â”€ Fertile window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_fertile_window:
      name: Notify - Fertile Window Started
      description: Send a notification when the fertile window begins.
      default: true
      selector:
        boolean:

    # â”€â”€ PMS window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_pms_window:
      name: Notify - PMS Window
      description: Send a daily notification during the 5-day PMS window.
      default: true
      selector:
        boolean:

    # â”€â”€ Ovulation phase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_ovulation:
      name: Notify - Ovulation Phase Started
      description: Send a notification when the current phase changes to Ovulation.
      default: false
      selector:
        boolean:

    # â”€â”€ Period start reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_period_reminder:
      name: Notify - Period Start Reminder (Confirmable)
      description: >
        On the predicted period start day, send a notification with a
        "Log it now" button. Repeats daily until the period is logged.
      default: true
      selector:
        boolean:

    period_reminder_action_id:
      name: Period Reminder Action ID
      description: >
        A unique identifier for the "Log it now" button action. Must be
        different for each automation using this blueprint (e.g. if you have
        two trackers, use "LOG_PERIOD_ALEX" and "LOG_PERIOD_JORDAN").
      default: "LOG_PERIOD_STARTED"
      selector:
        text:

    tracker_for_service:
      name: Tracker (for action button)
      description: >
        Leave empty if you only have one tracker. For multiple trackers,
        enter the tracker name (e.g. "Alex") so the button logs to the
        correct person.
      default: ""
      selector:
        text:

    # â”€â”€ Period end reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_period_end_reminder:
      name: Notify - Period End Reminder (Confirmable)
      description: >
        On the expected period end day, send a daily notification with a
        "Log it now" button. Repeats until the period end is logged.
      default: true
      selector:
        boolean:

    period_end_reminder_action_id:
      name: Period End Reminder Action ID
      description: >
        A unique identifier for the "Log period end" button action. Must be
        different for each automation using this blueprint (e.g.
        "LOG_PERIOD_END_ALEX" and "LOG_PERIOD_END_JORDAN" for two trackers).
      default: "LOG_PERIOD_ENDED"
      selector:
        text:


# â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
trigger:

  # Period started
  - platform: state
    entity_id: !input period_active_sensor
    to: "on"
    id: period_started

  # Period ended
  - platform: state
    entity_id: !input period_active_sensor
    to: "off"
    id: period_ended

  # Fertile window began â€” template trigger discovers entity from integration
  - platform: template
    value_template: >
      {% set entities = integration_entities('menstrual_cycle_tracker')
         | select('search', 'fertile_window') | list %}
      {{ entities | count > 0 and is_state(entities | first, 'Yes') }}
    id: fertile_window

  # Ovulation phase â€” same approach
  - platform: template
    value_template: >
      {% set entities = integration_entities('menstrual_cycle_tracker')
         | select('search', 'current_phase') | list %}
      {{ entities | count > 0 and is_state(entities | first, 'Ovulation') }}
    id: ovulation

  # Daily check (period due soon + PMS window + overdue reminder)
  - platform: time
    at: !input daily_check_time
    id: daily_check

  # "Log it now" button tapped on the period start reminder notification
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input period_reminder_action_id
    id: period_start_confirmed

  # "Log it now" button tapped on the period end reminder notification
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input period_end_reminder_action_id
    id: period_end_confirmed


# â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# All entity IDs are derived automatically from the selected binary sensor's device.
variables:
  period_active_sensor: !input period_active_sensor
  _dev_id: "{{ device_id(period_active_sensor) }}"
  _entities: "{{ device_entities(_dev_id) }}"
  next_period_sensor: "{{ _entities | select('search', 'next_period') | first | default('') }}"
  fertile_window_sensor: "{{ _entities | select('search', 'fertile_window') | first | default('') }}"
  current_phase_sensor: "{{ _entities | select('search', 'current_phase') | first | default('') }}"
  notify_service: !input notify_service
  name_subject: !input name_subject
  name_possessive: !input name_possessive
  period_warning_days: !input period_warning_days
  enable_period_due: !input enable_period_due
  enable_period_started: !input enable_period_started
  enable_period_ended: !input enable_period_ended
  enable_fertile_window: !input enable_fertile_window
  enable_pms_window: !input enable_pms_window
  enable_ovulation: !input enable_ovulation
  enable_period_reminder: !input enable_period_reminder
  period_reminder_action_id: !input period_reminder_action_id
  enable_period_end_reminder: !input enable_period_end_reminder
  period_end_reminder_action_id: !input period_end_reminder_action_id
  tracker_for_service: !input tracker_for_service
  days_until: >
    {{ state_attr(next_period_sensor, 'days_until_next_period') | int(-1) }}
  days_overdue: >
    {{ state_attr(next_period_sensor, 'days_overdue') | int(-1) }}
  days_period_end_overdue: >
    {{ state_attr(period_active_sensor, 'days_period_end_overdue') | int(-1) }}


# â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
action:
  - choose:

      # â”€â”€ Period started â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: period_started
          - condition: template
            value_template: "{{ enable_period_started }}"
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "{{ name_possessive }} Period Started"
              message: >
                {{ name_possessive }} period has started today. ðŸ’™

      # â”€â”€ Period ended â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: period_ended
          - condition: template
            value_template: "{{ enable_period_ended }}"
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "{{ name_possessive }} Period Ended"
              message: >
                {{ name_possessive }} period has ended.
                Next period predicted: {{ states(next_period_sensor) }}.

      # â”€â”€ Fertile window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Confirms it is THIS device's fertile window sensor that is active.
      - conditions:
          - condition: trigger
            id: fertile_window
          - condition: template
            value_template: >
              {{ enable_fertile_window
                 and fertile_window_sensor != ''
                 and is_state(fertile_window_sensor, 'Yes') }}
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "Fertile Window"
              message: >
                {{ name_subject }} {{ "have" if name_subject in ["You", "They", "We"] else "has" }}
                entered {{ name_possessive | lower }} fertile window today.

      # â”€â”€ Ovulation phase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Confirms it is THIS device's current phase sensor that is Ovulation.
      - conditions:
          - condition: trigger
            id: ovulation
          - condition: template
            value_template: >
              {{ enable_ovulation
                 and current_phase_sensor != ''
                 and is_state(current_phase_sensor, 'Ovulation') }}
        sequence:
          - service: "{{ notify_service }}"
            data:
              title: "Ovulation Phase"
              message: >
                {{ name_possessive }} cycle has entered the Ovulation phase.

      # â”€â”€ Daily check: period due soon + PMS window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Both checks run independently so both can fire on the same day.
      - conditions:
          - condition: trigger
            id: daily_check
        sequence:

          # Period due soon
          - if:
              - condition: template
                value_template: >
                  {{ enable_period_due and days_until == period_warning_days | int }}
            then:
              - service: "{{ notify_service }}"
                data:
                  title: "Period Due Soon"
                  message: >
                    {{ name_possessive }} period is predicted to start in
                    {{ days_until }} day{% if days_until != 1 %}s{% endif %}
                    ({{ states(next_period_sensor) }}).

          # PMS window â€” independent check, can fire same day as period-due
          - if:
              - condition: template
                value_template: >
                  {{ enable_pms_window and days_until >= 0 and days_until <= 5 }}
            then:
              - service: "{{ notify_service }}"
                data:
                  title: "PMS Window"
                  message: >
                    {% if days_until == 0 %}
                    {{ name_possessive }} period is expected today.
                    {% else %}
                    {{ name_subject }}
                    {{ "are" if name_subject in ["You", "They", "We"] else "is" }}
                    in {{ name_possessive | lower }} PMS window â€”
                    {{ days_until }} day{% if days_until != 1 %}s{% endif %} until {{ name_possessive | lower }} next period.
                    {% endif %}

          # Period start reminder â€” fires on the expected day and every day after
          # until the period is logged. Includes a "Log it now" action button.
          - if:
              - condition: template
                value_template: >
                  {{ enable_period_reminder and days_overdue >= 0
                     and not is_state(period_active_sensor, 'on') }}
            then:
              - service: "{{ notify_service }}"
                data:
                  title: >
                    {% if days_overdue == 0 %}
                    {{ name_possessive }} Period Is Due Today
                    {% else %}
                    {{ name_possessive }} Period Is {{ days_overdue }} Day{% if days_overdue != 1 %}s{% endif %} Late
                    {% endif %}
                  message: >
                    {% if days_overdue == 0 %}
                    {{ name_possessive }} period was predicted to start today.
                    {% else %}
                    {{ name_possessive }} period was predicted {{ days_overdue }}
                    day{% if days_overdue != 1 %}s{% endif %} ago and hasn't been logged yet.
                    {% endif %}
                    Did it start?
                  data:
                    actions:
                      - action: "{{ period_reminder_action_id }}"
                        title: "Log it now"

          # Period end reminder â€” fires on the expected last day and every day
          # after until the period end is logged.
          - if:
              - condition: template
                value_template: >
                  {{ enable_period_end_reminder and days_period_end_overdue >= 0
                     and is_state(period_active_sensor, 'on') }}
            then:
              - service: "{{ notify_service }}"
                data:
                  title: >
                    {% if days_period_end_overdue == 0 %}
                    {{ name_possessive }} Period Expected to End Today
                    {% else %}
                    {{ name_possessive }} Period Is {{ days_period_end_overdue }} Day{% if days_period_end_overdue != 1 %}s{% endif %} Longer Than Usual
                    {% endif %}
                  message: >
                    {% if days_period_end_overdue == 0 %}
                    {{ name_possessive }} period is expected to end today based on average cycle data.
                    {% else %}
                    {{ name_possessive }} period has been running {{ days_period_end_overdue }}
                    day{% if days_period_end_overdue != 1 %}s{% endif %} longer than average.
                    {% endif %}
                    Has it ended?
                  data:
                    actions:
                      - action: "{{ period_end_reminder_action_id }}"
                        title: "Log it now"

      # â”€â”€ Period start confirmed via notification button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: period_start_confirmed
        sequence:
          - service: menstrual_cycle_tracker.log_period_start
            data:
              tracker: "{{ tracker_for_service }}"
          - service: "{{ notify_service }}"
            data:
              title: "Period Logged"
              message: >
                {{ name_possessive }} period start has been logged for today.

      # â”€â”€ Period end confirmed via notification button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: period_end_confirmed
        sequence:
          - service: menstrual_cycle_tracker.log_period_end
            data:
              tracker: "{{ tracker_for_service }}"
          - service: "{{ notify_service }}"
            data:
              title: "Period End Logged"
              message: >
                {{ name_possessive }} period end has been logged for today.

mode: parallel
max: 5
